---
title: php-fpm是什么？
date: 2019-12-18 10:39:37
categories: PHP
---

# 前言

在知道php-fpm是什么之前，需要先知道nginx、cgi、fastcgi这三个东西。

首先要知道的一点，nginx只是分发功能，它不能处理动态资源。如果客户端请求静态资源（html、图片等）nginx会直接将静态文件返回。如果是类似API接口这种需要后端php程序处理的请求，nginx不能执行程序，所以它必须将这个请求交给php的解释器，php解释器执行完后，返回给nginx，再由nginx返回给客户端。

# cgi、fastcgi

cgi：通用网关接口

直接去维基百科或者百度百科，看得一愣一愣的，啥玩意儿。于是乎我只能按照我看到的资料进行归纳总结便于自己理解。

cig我理解为一种通信协议（类似http这种）。它是用于谁和谁之间通信的呢？通过上面的前言可以知道，nginx需要把动态接口转发给php解释器执行，那这个cig就是用于nginx和服务端程序之间通信的协议（不限于php程序，只要符合协议要求，并实现了协议程序，就可以通信）。

cgi具体如何规定的或者如何实现的，这个就不深入了，只要知道它是用来规定通信的一种协议就够了。既然有了cig为什么还有fastcgi呢？肯定是因为cgi有缺陷嘛。

cig最大的问题是每次一个动态的请求进来，它都会开启一个新的进程去处理，结束后再关闭，对于资源的消耗非常大，遇上高并发就GG了。

fastcgi的提出就是针对cgi这些缺点的，它会先开启一个master进程加载好php配置，然后再开启worker子进程，这些worker进程才是用来处理动态请求的。worker的数量会随着请求数量的变化而改变，而且由于master进程的常驻内存，不需要每次都去启动全新的进程，从而提高了并发能力。

cgi基本上已经是过去式了，现在大部分的公司都是使用的fastcgi这种协议。

# php-fpm

从前面的内容可以知道php程序需要通过fastcig协议和nginx这类服务器软件通信。php-fpm就是实现这个协议的程序，可以理解为http协议和浏览器的关系。

php-fpm接收到来自nginx的请求后去执行相应的php程序，然后把结果以fastcgi协议的格式返回给nginx，再由nginx返回给客户端。

除了需要实现fastcgi协议外，php-fpm还有进程管理功能，所谓的进程池。根据php-fpm默认的配置，一般会启动一个master进程，然后启动两个worker进程等待请求进来，worker不够用时增加worker数量。可以通过修改php-fpm的配置文件修改默认开启的worker数量，一般一个worker消耗大约20m内存，生产环境下可以尽量开多一些，减少因为创建进程导致的消耗。

# 处理请求流程图

{% asset_img php-fpm工作流程.png %}